---
title: "[ë„¤ì´ë²„ ë¶€ìŠ¤íŠ¸ ìº í”„] AI-Tech - Lv2 week4(2)"
categories: AI boostcourse
tags: python
published: true
use_math: true
---

## í•™ìŠµê¸°ë¡ - 40

ì˜¤ëŠ˜ í•  ì¼  

- 2 Stage Detectors (Fast R-CNN ~)

## 1. ê°•ì˜ ë³µìŠµ ë‚´ìš©

- Fast R-CNN

  - Overall Architecture  

      ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img20.png){: width="50%" height="50%"}  

    Imageë¥¼ VGG Netì— Inputìœ¼ë¡œ í†µê³¼í•´ì„œ feature map ì¶”ì¶œ í›„, feature map ìƒì—ì„œ RoIë¥¼ ê³„ì‚° (RoI projection ì´ìš©)  

      ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img21.png){: width="50%" height="50%"}  

    RoI Projection  
    Selective Searchë¥¼ ì´ìš©í•´ì„œ ë‚˜ì˜¨ RoI Imageë¥¼ feature mapì˜ í¬ê¸°ì— ë§ê²Œ íˆ¬ì˜ì‹œí‚¨ë‹¤.  

      ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img22.png){: width="50%" height="50%"}  

    RoI Poolingì„ í†µí•´ ì¼ì •í•œ í¬ê¸°ì˜ feature ì¶”ì¶œ  
    ê³ ì •ëœ vectorë¥¼ ì–»ê¸° ìœ„í•œ ê³¼ì •ìœ¼ë¡œ SPP (Spatial Pyramid Pooling)ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•œë‹¤.  
    Pyramid level: 1, Target grid size: 7X7 í•œ ê°œë§Œ ì´ìš©  
    (ì§ˆë¬¸) ì•„ë˜ ê·¸ë¦¼ì€ Target grid sizeê°€ 8x8 ì¸ë°? 3by2 gridë¡œ mining?  

      ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img23.png){: width="50%" height="50%"}  

    Fully Connected Layer ì´í›„, Softmax Classifierê³¼ Bounding Box Regressor ì¶œë ¥  
    í´ë˜ìŠ¤ ê°œìˆ˜ (C+1) : í´ë˜ìŠ¤ (C) + ë°°ê²½ (1)

      ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img24.png){: width="50%" height="50%"}  

  - Training
    - Multi task loss ì‚¬ìš© (classification loss + bounding box regression)
    - Loss function
      - Classification : Cross Entropy, BB regressor : Smooth L1
    - Dataset êµ¬ì„±
      - IoU > 0.5 : positive samples
      - 0.1 < IoU < 0.5 : negative samples
      - Positive samples 25%, negative samples 75%  
    - Hierarchical sampling
      - R-CNN ì˜ ê²½ìš° ì´ë¯¸ì§€ì— ì¡´ì¬í•˜ëŠ” RoI ë¥¼ ì „ë¶€ ì €ì¥í•´ ì‚¬ìš©
      - í•œ ë°°ì¹˜ì— ì„œë¡œ ë‹¤ë¥¸ ì´ë¯¸ì§€ì˜ RoI ê°€ í¬í•¨ë¨ (1ë²ˆ ì´ë¯¸ì§€ì—ì„œ RoIë¥¼ ë½‘ì„ ë•Œ, 2000ì¥, 2ë²ˆ ì´ë¯¸ì§€ì—ì„œ ë½‘ì„ ë•Œ, 2000ì¥, ... -> Positive, Negativeë¥¼ ê³¨ë¼ë‚¸ë‹¤.)
      - Fast R CNN ì˜ ê²½ìš° í•œ ë°°ì¹˜ì— í•œ ì´ë¯¸ì§€ì˜ RoI ë§Œì„ í¬í•¨
      - í•œ ë°°ì¹˜ ì•ˆì—ì„œ ì—°ì‚°ê³¼ ë©”ëª¨ë¦¬ë¥¼ ê³µìœ í•  ìˆ˜ ìˆìŒ

  - Shortcomings
  1), 2), 3) í•´ê²°, but, 4)ëŠ” ì• ë§¤í•´ì§„ë‹¤.  
  Fast R-CNN ê°™ì€ ê²½ìš°ì—”, Selective Searchê°€ CPUì—ì„œ ëŒì•„ê°€ëŠ” ì•Œê³ ë¦¬ì¦˜ì´ê¸° ë•Œë¬¸ì—, end-to-endë¼ê³  ë³¼ ìˆ˜ ì—†ë‹¤.

- Faster R-CNN  

  - Pipeline  
    **RPN(Region Proposal Network)**ë¥¼ ì´ìš©í•´ì„œ Selective Search ëŒ€ì²´  
    Overall Architecture  
      ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img25.png){: width="50%" height="50%"}  

    ì´ë¯¸ì§€ë¥¼ CNNì— ë„£ì–´ feature maps ì¶”ì¶œ (CNNì„ í•œ ë²ˆë§Œ ì‚¬ìš©)  
    RPNì„ í†µí•´ RoI ê³„ì‚° (Anchor box ê°œë…ì„ ì‚¬ìš©)  

    Anchor boxëŠ” feature mapì´ vectorí˜•ì‹ìœ¼ë¡œ ë‚˜ì™”ì„ ë•Œ, ê° ì…€ë§ˆë‹¤ ì—¬ëŸ¬ ê°œì˜ í¬ê¸°ë¥¼ ê°€ì§„ boxë¥¼ ë‘ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤.  

      ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img26.png){: width="25%" height="25%"}  

    í•˜ì§€ë§Œ ê° ì…€ ë³„ë¡œ ëª¨ë‘ ì•µì»¤ ë°•ìŠ¤ë¥¼ ê°–ê³  ìˆë‹¤ë©´, ê·¸ ì—­ì‹œ ê°¯ìˆ˜ê°€ ë§ì•„ì§€ê²Œ ëœë‹¤.  
    RPNì€ ì•µì»¤ ë°•ìŠ¤ê°€ ê°ì²´ë¥¼ í¬í•¨í•˜ê³  ìˆëŠ” ì§€ ì˜ˆì¸¡í•˜ëŠ” ê·¼ê±° (2k scores) ì™€ ê°ì²´ë¥¼ í¬í•¨í•œë‹¤ë©´, ì•µì»¤ ë°•ìŠ¤ì˜ bounding boxë¥¼ ë¯¸ì„¸ ì¡°ì • (4k coordinates) ì„ í•˜ëŠ” ì—­í•   
    Faster R-CNNì—ì„œëŠ” 9ê°œì˜ anchor boxë¥¼ ì´ìš©í•˜ê²Œ ëœë‹¤. (3ê°€ì§€ scale, 3ê°€ì§€ ë¹„ìœ¨)  

      ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img27.png){: width="50%" height="50%"}  

    RPNì— ëŒ€í•œ ë” ìì„¸í•œ ì„¤ëª…ì„ í•˜ìë©´,  
    CNNì„ í†µí•´ì„œ ë‚˜ì˜¨ Feature Mapì—ì„œ 3by3 convë¥¼ í†µí•´ì„œ Intermediate layer ìƒì„±  
    (ì§ˆë¬¸) Intermediate layerë¥¼ ìƒì„±í•œ ì´ìœ ëŠ”? í•™ìŠµì„ ìœ„í•´ì„œ convolutionì„ ì ìš©í•œ ê²ƒì¸ê°€?  
    1by1 conv ìˆ˜í–‰í•´ì„œ binary classification, bounding box regression ìˆ˜í–‰  

      ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img28.png){: width="50%" height="50%"}  
  
    í‰ë©´í™”ë¥¼ í•´ë³´ë©´, ë‹¤ìŒê³¼ ê°™ì´ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤.  
    (ì§ˆë¬¸) ê° ì…€ë§ˆë‹¤ anchor boxë¥¼ generatorë¥¼ í•œë‹¤ê³  í–ˆëŠ”ë° í•˜ëŠ” ì´ìœ ëŠ”? êµ³ì´ ì•ˆí•´ë„ ìœ„ì—ì„œì²˜ëŸ¼ 1by1 conv layerë¥¼ í†µí•´ì„œ ë§Œë“¤ ìˆ˜ ìˆì§€ ì•Šì„ê¹Œ?  
    Cls prediction headë¥¼ í†µê³¼í•œë‹¤ë©´ scoreê°€ ë‚˜ì˜¬í…ë°, scoreë¥¼ í†µí•´ì„œ Select Top N Boxesë¥¼ í•  ìˆ˜ ìˆë‹¤. Top Boxesë¥¼ ëŒ€ìƒìœ¼ë¡œ Coordinatesë¥¼ ì ìš©í•  ìˆ˜ ìˆê²Œ ëœë‹¤. (ì¬ì¡°ì •)  

      ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img29.png){: width="50%" height="50%"}  

    **NMS** (Non-Maximu Suppression)  

    - ìœ ì‚¬í•œ RPN Proposal ì œê±°ì— ì‚¬ìš©
    - Class scoreë¥¼ ê¸°ì¤€ìœ¼ë¡œ Proposals ë¶„ë¥˜
    - IoUê°€ 0.7 ì´ìƒì¸ proposals ì˜ì—­ë“¤ì€ ì¤‘ë³µëœ ì˜ì—­ìœ¼ë¡œ íŒë‹¨í•œ ë’¤ ì œê±°

    ì•„ë˜ì™€ ê°™ì´ boxì— ëŒ€í•œ class scoreë¥¼ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤.  
    (ì§ˆë¬¸) bb4ëŠ” scoreê°€ 0ì¸ë° ì—†ì• ì§€ ì•Šê³  bb1ê³¼ ë¹„êµí•˜ëŠ” ê²ƒì¼ê¹Œ?  

      ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img30.png){: width="50%" height="50%"}  

    ê°€ì¥ class scoreê°€ ë†’ì€ bb1ì— ëŒ€í•´ì„œ ë‚˜ë¨¸ì§€ bboxì˜ IoUë¥¼ ë‚˜íƒ€ë‚´ë©´, ë‹¤ìŒê³¼ ê°™ë‹¤. ì—¬ê¸°ì„œ IoUê°€ 0.7ì´ìƒ ì¦‰, ê±°ì˜ ë¹„ìŠ·í•  ê²½ìš°, ì œê±°í•œë‹¤.  

      ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img31.png){: width="50%" height="50%"}  

    Fast R-CNN vs Faster R-CNN  
    ë‘ ëª¨ë¸ì˜ ì°¨ì´ì ì€ RoI Projection ì´ì „ì— RoIë¥¼ ì–´ë–»ê²Œ ë½‘ëŠëƒì— ë”°ë¼ ë‹¬ë¼ì§€ëŠ” ê²ƒì´ë‹¤.  

      ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img32.png){: width="50%" height="50%"}  

  - Training  
    - RPN ë‹¨ê³„ì—ì„œ classification ê³¼ regressor í•™ìŠµì„ ìœ„í•´ ì•µì»¤ë°•ìŠ¤ë¥¼ positive/negative samples êµ¬ë¶„  
    - ë°ì´í„°ì…‹ êµ¬ì„±  
      - IoU > 0.7 or highest IoU with GT: positive samples
      - IoU < 0.3: negative samples
      - Otherwise : í•™ìŠµë°ì´í„°ë¡œ ì‚¬ìš© X

    - Loss í•¨ìˆ˜ (Fast R-CNNê³¼ ë™ì¼)  
    Multi-taskë¡œ í•™ìŠµì„ í•œë‹¤. (Lcls : CE Loss, Lreg : MSE)  
    pi*ëŠ” ië²ˆì§¸ anchor boxê°€ ê°ì²´ë¥¼ í¬í•¨í•˜ê³  ìˆëŠ” ì§€ì— ëŒ€í•œ ì˜ë¯¸.  

    $L\left(\left\{p_{i}\right\},\left\{t_{i}\right\}\right)=\frac{1}{N_{c l s}} \sum_{i} L_{c l s}\left(p_{i}, p_{i}^{*}\right)$ $+\lambda \frac{1}{N_{r e g}} \sum_{i} p_{i}^{*} L_{r e g}\left(t_{i}, t_{i}^{*}\right)$

    - paperì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ Alternative trainingì„ í™œìš©í•œë‹¤.  
      Step 1) Imagenet pretrained backbone load + RPN í•™ìŠµ  
      Step 2) Imagenet pretrained backbone load + RPN from step 1 + Fast RCNN í•™ìŠµ  
      Step 3) Step 2 finetuned backbone load & freeze + RPN í•™ìŠµ  
      Step 4) Step 2 finetuned backbone load & freeze + RPN from step 3 + Fast RCNN í•™ìŠµ  

      í•˜ì§€ë§Œ, í•™ìŠµ ê³¼ì •ì´ ë§¤ìš° ë³µì¡í•´ì„œ, ìµœê·¼ì—ëŠ” Approximatel Approximate Joint Training í™œìš©  
      Resultsë¥¼ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ Selective Searchì— ë¹„í•´ì„œ ì„±ëŠ¥ê³¼ ì†ë„ê°€ ê°œì„ ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.  

        ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img33.png){: width="50%" height="50%"}  

    - ShortComings  
      ì´ì „ì— R-CNN, Fast R-CNNì—ì„œ ê°€ì§€ê³  ìˆë˜ ë‹¨ì ë“¤ (1,2,3,4) ëª¨ë‘ ì—†ì•¨ ìˆ˜ ìˆì—ˆë‹¤. í•˜ì§€ë§Œ RPN, NMSë¥¼ í•˜ê³  Fast R-CNNì„ ê·¸ëŒ€ë¡œ í•œë‹¤ëŠ” ì ì— ìˆì–´ì„œ Real-timeì´ ë§¤ìš° ëŠë¦¬ë‹¤ëŠ” í•œê³„ì ì´ ìˆë‹¤.  

- Summary  

  ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img34.png){: width="50%" height="50%"}  

## 2. ê³ ë¯¼ ë‚´ìš©, ê²°ê³¼ (ê³¼ì œ ìˆ˜í–‰ ê³¼ì •, ê²°ê³¼ë¬¼ ì •ë¦¬)

### ì§ˆë¬¸

(ì§ˆë¬¸)  

ì•„ë˜ ê·¸ë¦¼ì€ Target grid sizeê°€ 8x8 ì¸ë°? 3by2 gridë¡œ mining?  
Sol. Paperì—ì„œëŠ” Target Sizeê°€ 7x7 sizeë¡œ ê³ ì •í–ˆì„ ë¿, Input sizeì— ë”°ë¼ RoIê°€ ê°€ë³€ì ì¼ ìˆ˜ ìˆê¸°ì— Target Size ë˜í•œ ë°”ë€” ìˆ˜ ìˆìŠµë‹ˆë‹¤!  

  ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img23.png){: width="50%" height="50%"}  

(ì§ˆë¬¸)  

1. Intermediate layerë¥¼ ìƒì„±í•œ ì´ìœ ëŠ”? í•™ìŠµì„ ìœ„í•´ì„œ convolutionì„ ì ìš©í•œ ê²ƒì¸ê°€?  
Sol. Intermediate layerëŠ” CNNì˜ ì¤‘ê°„ ë‹¨ê³„ (conv5) ëª¨ë“  convolution ë‹¨ê³„ë¥¼ ë¹ ì ¸ë‚˜ì˜¨ ìƒíƒœì˜ layerë¥¼ ì˜ë¯¸í•œë‹¤.  (Intermediate : ì¤‘ê°„ì˜)

2. ê° ì…€ë§ˆë‹¤ anchor boxë¥¼ generatorë¥¼ í•œë‹¤ê³  í–ˆëŠ”ë° í•˜ëŠ” ì´ìœ ëŠ”? êµ³ì´ ì•ˆí•´ë„ ìœ„ì—ì„œì²˜ëŸ¼ 1by1 conv layerë¥¼ í†µí•´ì„œ ë§Œë“¤ ìˆ˜ ìˆì§€ ì•Šì„ê¹Œ?  
Sol. 9 ê°œì˜ anchor boxë¥¼ generate í•˜ëŠ” ê³¼ì •ì´ê³ , generateëœ 9ê°œì˜ ë°•ìŠ¤ì—ì„œ 1 by 1 convolution ì„ í†µí•´ scoreì™€ coordinatesë¡œ ë‚˜ëˆ ì§€ê²Œ ëœë‹¤.  
++ GenerateëŠ” HyperParameterì— ì˜í•´ ê²°ì •ë˜ì–´ì§„ë‹¤.  

  ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img35.png){: width="50%" height="50%"}  

(ì§ˆë¬¸) bb4ëŠ” scoreê°€ 0ì¸ë° ì—†ì• ì§€ ì•Šê³  bb1ê³¼ ë¹„êµí•˜ëŠ” ê²ƒì¼ê¹Œ?  

  ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img30.png){: width="50%" height="50%"}  

ìœ„ì—ì„œ ë§í•˜ëŠ” class score for each boxëŠ” ê°ì²´ë¥¼ ê²€ì¶œí–ˆëŠ” ì§€ì— ëŒ€í•œ Bounding boxì˜ ìƒì„± ì—¬ë¶€ë¥¼ scoreë¡œ ë‚˜íƒ€ë‚¸ ê²ƒì´ê³ , ì´ Bounding boxë“¤ ì¤‘ì—ì„œ ê°™ì€ ê°ì²´ë¥¼ ê°€ë¦¬í‚¤ëŠ” ë§ì€ ì •ë³´ë¥¼ ê°€ì§„ (IoU â‰¥ 0.7) bboxë¥¼ ì§€ìš°ëŠ” ë°©ì‹ì´ë‹¤. ë”°ë¼ì„œ bb4ëŠ” ìš°ë¦¬ê°€ ì•Œê³ ìí•˜ëŠ” ê°ì²´ì˜ ì—°ê´€ì„±ì„ ë‚˜íƒ€ë‚´ê¸° ë•Œë¬¸ì— ì‚­ì œë¥¼ í•˜ì§€ ì•ŠëŠ” ê²ƒì´ë‹¤.  
ì¶”ê°€ë¡œ, RPN ë‹¨ê³„ì—ì„œ Dataset êµ¬ì„± ì‹œì— IoUì— ë”°ë¼ sampleì„ ë‹¤ë¥´ê²Œ ì§€ì •í•œë‹¤.  (ê°•ì˜ìë£Œ-77P)

  ![Untitled](/assets/images/AI-Images2/lv2_week2_3/img36.png){: width="50%" height="50%"}  

### ê³¼ì œ  


## 3. í”¼ì–´ì„¸ì…˜ ì •ë¦¬

1,2ê°• ê°•ì˜ì •ë¦¬
ë°œí‘œì: ê¹€ì¤€ì˜

### ğŸ“¢ì§ˆë¬¸

  [Q.Fast R-CNN - SPP Grid SizeëŠ” Input Imageì— ë”°ë¼ ê°€ë³€ì ì´ì–´ì•¼ í•˜ë‚˜?](https://www.notion.so/Fast-R-CNN-SPP-Grid-Size-Input-Image-4607ec9072174d53b45f2b309498ec2a)

  [Q.Faster-R-CNN - Feature Mapì—ì„œ Intermediate layerë¥¼ ìƒì„±í•˜ëŠ” ì´ìœ ? & Generate í•˜ëŠ” ì´ìœ  ?](https://www.notion.so/Faster-R-CNN-Feature-Map-Intermediate-layer-Generate-50be069d63fb491991e7194855c4c9ab)

  [Q.RPN ì´í›„, NMSì—ì„œ class scoreê°€ 0ì¸ë°ë„ ë¹„êµí•˜ëŠ” ì´ìœ ?](https://www.notion.so/RPN-NMS-class-score-0-18f3a1a57643402193a7ac836c33e0d6)

### ğŸ“¢ê°ìí•œê±° ê³µìœ 

  **ê¹€ì¤€ì˜** - special mission, (EDA)Draw_BB ê³µìœ 
  **ì„ì„±ë¯¼** - special mission - ì„œë²„ ê¸°ì¤€ ì½”ë“œ ì‚¬ìš© >> cocoë°ì´í„° ì‚¬ìš©í•˜ë©´ ì•ˆë¨   /  CosineAnnealing íš¨ìš©ì„± ì—†ìŒ  /   Adamê³¼ loss ì°¨ì´ í¬ê²Œ ì—†ìŒ SGDê°€ ì†ë„ëŠ” ë” ë¹ ë¦„  /  EDA ê´€ë ¨ ì‘ì„±
  **ê¹€í˜„ìˆ˜** - ë² ì´ì§ ì½”ë“œ
  **ì•ˆì†Œì •** - ë² ì´ì§ ì½”ë“œ
  **ê¹€ê±´** - ë² ì´ì§ ì½”ë“œ
  **í™©ì£¼ì˜** - ë² ì´ì§ ì½”ë“œ

### ğŸ“¢í˜‘ì—…ê´€ë ¨

- ê°ì ì½”ë“œë¥¼ ì™„ì„± í•  ìˆ˜ ìˆì„ ì •ë„ê°€ ë˜ëŠ” ê²ƒì„ ëª©í‘œí•˜ë˜ ê°ì ë¶„ì•¼ë¥¼ ë‚˜ëˆ ì„œ êµ¬í˜„í•œë‹¤. ë¹„ìŠ·í•œ ë‚´ìš©ì´ë¼ ë‚˜ëˆ ì„œ êµ¬í˜„í•´ë„ ê¸ˆë°© ë°°ìš¸ ìˆ˜ ìˆì„ê±° ê°™ë‹¤. ì„œë¡œ ë³´ì™„ì„ í•  ìˆ˜ ìˆì„ê±° ê°™ë‹¤.
- 3ê°€ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ëŒ€í•´ 3íŒ€ì„ ë‚˜ëˆ„ì–´ ì§„í–‰í•´ ê³µë¶€í•˜ê³  ì„œë¡œ ë¦¬ë·°í•´ì£¼ë©° ê³µìœ í•˜ê¸°.

**faster_rcnn** >> ê¹€í˜„ìˆ˜, ì•ˆì†Œì •
**detectron2** >> ì„ì„±ë¯¼, í™©ì£¼ì˜
**mmdetection** >> ê¹€ì¤€ì˜, ê¹€ê±´

## 4. í•™ìŠµ íšŒê³ 

- 